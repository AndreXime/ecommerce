---
import Layout from "@/layout/layout.astro";
import CheckoutComponent from "./_checkout";
import { ShieldCheck, Zap } from "lucide-preact";
import { serverGet } from "@/lib/serverApi";
import type { User } from "@/database/users";
import type { CartItem } from "@/database/productsTypes";

export const prerender = false;

const cookieHeader = Astro.request.headers.get("cookie") ?? "";
if (!cookieHeader.trim()) return Astro.redirect("/login");

interface ApiCart {
    id: string;
    items: CartItem[];
}

const [userRes, cartRes] = await Promise.all([
    serverGet<User>("/users/me", cookieHeader),
    serverGet<ApiCart>("/cart", cookieHeader),
]);

if (userRes.status === 401 || !userRes.data) {
	return Astro.redirect(`/auth/refresh?redirect=${encodeURIComponent("/checkout")}`);
}

const user = { name: userRes.data.personalData.name, email: userRes.data.personalData.email };

const cartItems = cartRes.data?.items ?? [];
const subtotal = cartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
const orderSummary = {
    items: cartItems.map((item) => ({
        id: item.id,
        name: item.name,
        price: item.price,
        img: item.images[0] ?? "",
        quantity: item.quantity,
    })),
    subtotal,
    shipping: 0,
    total: subtotal,
};
---

<Layout
    title="Checkout Seguro | Emporium da Tecnologia"
    description="Finalize sua compra com segurança"
>
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div
            class="container mx-auto px-4 py-4 flex gap-3 justify-between items-center"
        >
            <a href="/" class="group flex items-center justify-center">
                <span
                    class="flex gap-2 items-center text-xl font-bold tracking-tight text-blue-700 group-hover:text-blue-900 transition"
                >
                    <span class="text-blue-600">
                        <Zap class="text-xl" />
                    </span>
                    <span class="whitespace-nowrap">
                        Emporium<span class="hidden min-[400px]:inline">
                            da Tecnologia</span
                        >
                    </span>
                </span>
            </a>
            <div class="flex items-center text-sm text-gray-500">
                <ShieldCheck class="mr-2 text-green-600" />
                Checkout Seguro
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 bg-gray-50/50">
        <CheckoutComponent client:load initialOrder={orderSummary} user={user} />
    </main>

    <footer
        class="mt-auto py-8 text-center text-sm text-gray-500 border-t border-gray-200 bg-white"
    >
        <p>
            &copy; 2024 Emporium da Tecnologia. Transação segura criptografada.
        </p>
    </footer>

    <style is:inline>
        .step-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .step-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .payment-tab.active {
            border-color: #2563eb;
            background-color: #eff6ff;
            color: #1e40af;
        }

        .step-indicator.active .step-number {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .step-indicator.completed .step-number {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        .step-indicator.completed .step-text { color: #10b981; }
    </style>
</Layout>
