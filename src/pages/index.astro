---
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Layout from "@/layout/layout.astro";
import StarRating from "@/components/StarRating";
import { serverGet } from "@/lib/serverApi";
import { formatPrice } from "@/lib/utils";
import { ArrowRight, ChevronLeft, ChevronRight } from "lucide-preact";
import type { PaginatedResponse, ProductSummary } from "@/database/productsTypes";

const [offersRes, bestSellersRes] = await Promise.all([
	serverGet<PaginatedResponse<ProductSummary>>("/products", null, {
		limit: 4,
		sortBy: "createdAt",
		sortOrder: "desc",
	}),
	serverGet<PaginatedResponse<ProductSummary>>("/products", null, {
		limit: 6,
		sortBy: "rating",
		sortOrder: "desc",
	}),
]);

const offers = offersRes.data?.data ?? [];
const bestSellers = bestSellersRes.data?.data ?? [];
---

<Layout title="Emporium da Tecnologia" description="">
	<Header />

	<section
		class="relative h-[500px] w-full bg-gray-900 overflow-hidden group"
	>
		<div class="absolute inset-0">
			<picture>
				<source
					srcset="/images/hero-768.webp"
					media="(max-width: 768px)"
					type="image/webp"
				/>
				<source
					srcset="/images/hero-1440.webp"
					type="image/webp"
				/>
				<img
					src="/images/hero-1440.webp"
					alt="Tecnologia Cyberpunk"
					fetchpriority="high"
					loading="eager"
					decoding="async"
					width="1440"
					height="960"
					class="w-full h-full object-cover opacity-60 group-hover:scale-105 transition duration-1000 ease-in-out"
				/>
			</picture>
			<div
				class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black opacity-80"
			>
			</div>
		</div>

		<div
			class="relative container mx-auto px-4 h-full flex flex-col justify-center items-center text-center z-10"
		>
			<span
				class="inline-block py-1 px-3 rounded-full bg-blue-600/30 border border-blue-500 text-blue-300 text-xs font-bold tracking-wider mb-4 uppercase backdrop-blur-sm"
			>
				Novidades 2024
			</span>
			<h1
				class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight drop-shadow-lg"
			>
				O Futuro da Tecnologia Chegou
			</h1>
			<p
				class="text-lg md:text-xl text-gray-200 max-w-2xl font-light drop-shadow-md"
			>
				Descubra as últimas novidades em eletrônicos de ponta. Preços
				imbatíveis, qualidade inigualável.
			</p>
			<div class="mt-8 flex gap-4">
				<a
					href="/produtos"
					class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-full transition transform hover:-translate-y-1 shadow-lg shadow-blue-600/50"
				>
					Ver Catálogo
				</a>
			</div>
		</div>
	</section>
	<main class="flex-grow container mx-auto px-4 py-12 space-y-16">
		<section>
			<div class="flex items-center justify-between mb-8">
				<div class="h-px bg-gray-200 flex-grow"></div>
				<h2
					class="text-2xl md:text-3xl font-bold text-gray-800 px-6 text-center"
				>
					Produtos em oferta
				</h2>
				<div class="h-px bg-gray-200 flex-grow"></div>
			</div>

			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
				{
					offers.map((product) => (
						<a
							href={`/produtos/${product.id}`}
							class="bg-white group rounded-xl shadow-sm hover:shadow-xl transition-shadow duration-300 border border-gray-100 overflow-hidden flex flex-col group"
						>
							<div class="relative h-48 bg-gray-100 overflow-hidden">
								<img
									src={product.images[0]}
									alt={product.name}
									class="w-full h-full object-cover group-hover:scale-110 transition duration-500"
								/>
								{product.discountPercentage && (
								<div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">
									DESCONTO de {product.discountPercentage}%
								</div>
								)}
							</div>
							<div class="p-4 flex-grow flex flex-col">
							<span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
								{product.tag}
							</span>
							<h3 class="text-lg font-bold text-gray-900 mt-1 mb-2">
								{product.name}
							</h3>
							<div class="flex items-center mb-3">
								<div class="text-yellow-400 text-xs flex">
									<StarRating rating={product.rating} />
								</div>
								<span class="text-xs text-gray-500 ml-2">
									{product.reviewsCount}
								</span>
							</div>
								<div class="mt-auto flex items-center justify-between">
									<span class="text-xl font-bold text-gray-900">
										{formatPrice(product.price)}
									</span>
									<span class="text-sm font-semibold text-gray-500 group-hover:text-blue-600 flex gap-1 items-center transition">
										Ver Detalhes <ArrowRight size={18} />
									</span>
								</div>
							</div>
						</a>
					))
				}
			</div>
		</section>

		<section class="relative">
			<div class="flex items-center justify-between mb-8">
				<div class="h-px bg-gray-200 flex-grow"></div>
				<h2
					class="text-2xl md:text-3xl font-bold text-gray-800 px-6 text-center"
				>
					Produtos mais vendidos
				</h2>
				<div class="h-px bg-gray-200 flex-grow"></div>
			</div>

			<div class="relative group/slider">
				<button
					id="scrollLeft"
					aria-label="Rolar para a esquerda"
					class="absolute left-0 top-1/2 -translate-y-1/2 -ml-4 z-10 bg-white border border-gray-200 text-gray-700 hover:text-blue-600 p-3 rounded-full shadow-lg transition duration-300 focus:outline-none hidden md:block"
				>
					<ChevronLeft size={22} aria-hidden="true" />
				</button>

				<div
					id="sliderContainer"
					role="list"
					aria-label="Produtos mais vendidos"
					class="flex overflow-x-auto space-x-6 pb-6 hide-scroll scroll-smooth"
				>
					{
						bestSellers.map((product) => (
							<a
								href={`/produtos/${product.id}`}
								role="listitem"
								class="min-w-[280px] md:min-w-[300px] bg-white rounded-xl group shadow-sm border border-gray-100 overflow-hidden flex flex-col"
							>
								<div class="h-48 bg-gray-100 overflow-hidden">
									<img
										src={product.images[0]}
										alt={product.name}
										class="w-full h-full object-cover"
									/>
								</div>
								<div class="p-4 flex-grow flex flex-col">
								<span class="text-xs font-semibold text-gray-500 uppercase">
									{product.tag}
								</span>
									<h3 class="text-lg font-bold text-gray-900 mt-1 mb-2">
										{product.name}
									</h3>
									<div class="flex items-center mb-3 text-yellow-400 text-xs">
										<StarRating rating={product.rating} />

										<span class="text-gray-500 ml-2">
											{product.reviewsCount}
										</span>
									</div>
									<div class="mt-auto flex justify-between items-center">
										<span class="text-xl font-bold text-gray-900">
											{formatPrice(product.price)}
										</span>
										<span class="text-sm font-semibold text-gray-500 group-hover:text-blue-600">
											Ver Detalhes
										</span>
									</div>
								</div>
							</a>
						))
					}
				</div>

				<button
					id="scrollRight"
					aria-label="Rolar para a direita"
					class="absolute right-0 top-1/2 -translate-y-1/2 -mr-4 z-10 bg-white border border-gray-200 text-gray-700 hover:text-blue-600 p-3 rounded-full shadow-lg transition duration-300 focus:outline-none hidden md:block"
				>
					<ChevronRight size={22} aria-hidden="true" />
				</button>
			</div>
		</section>

		<section class="flex justify-center pb-8">
			<a
				href={`/produtos`}
				class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-4 px-10 rounded-lg shadow-lg hover:shadow-xl transition transform hover:scale-105"
			>
				Ver Todos os Produtos
			</a>
		</section>
	</main>

	<script>
		const scrollContainer = document.getElementById("sliderContainer");
		const scrollLeftBtn = document.getElementById("scrollLeft");
		const scrollRightBtn = document.getElementById("scrollRight");

		if (scrollContainer && scrollLeftBtn && scrollRightBtn) {
			scrollLeftBtn.addEventListener("click", () => {
				scrollContainer.scrollBy({ left: -320, behavior: "smooth" });
			});

			scrollRightBtn.addEventListener("click", () => {
				scrollContainer.scrollBy({ left: 320, behavior: "smooth" });
			});
		}
	</script>

	<Footer />
</Layout>
